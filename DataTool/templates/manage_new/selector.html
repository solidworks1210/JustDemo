{% extends 'base.html' %}

{% block css %}
<script type="text/javascript">
    oFReader = new FileReader(), rFilter = /^(?:image\/bmp|image\/cis\-cod|image\/gif|image\/ief|image\/jpeg|image\/jpeg|image\/jpeg|image\/pipeg|image\/png|image\/svg\+xml|image\/tiff|image\/x\-cmu\-raster|image\/x\-cmx|image\/x\-icon|image\/x\-portable\-anymap|image\/x\-portable\-bitmap|image\/x\-portable\-graymap|image\/x\-portable\-pixmap|image\/x\-rgb|image\/x\-xbitmap|image\/x\-xpixmap|image\/x\-xwindowdump)$/i;

    oFReader.onload = function (oFREvent) {
        document.getElementById("uploadPreview").src = oFREvent.target.result;
    };
    var imges = '';
    // 还原图片
    function recoveryImage(){
        $('#modal-body input[type="file"]').val('');
        $('#modal-body .body-img img').attr('src', imges);
    }
    function loadImageFile() {
        if (document.getElementById("uploadImage").files.length === 0) {
            return;
        }
        var oFile = document.getElementById("uploadImage").files[0];
        if(oFile.size > 8*1024*1024){
            alert('图片太大，请重新选择，8M 以内');
            return;
        }
        if (!rFilter.test(oFile.type)) {
            alert("请选择图片文件!");
            return;
        }
        oFReader.readAsDataURL(oFile);
    }
</script>
{% end %}

{% block modal %}
<!--模态框-->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"
     style="box-shadow:none;background-color: transparent;">
    <div class="modal-dialog">
        <form method="post" enctype="multipart/form-data" action="/selector-make/{{ category }}">
            {% raw xsrf_form_html() %}
            <!--隐藏-->
            <input type="hidden" name="id" id="id">
            <input type="hidden" name="page_current" id='page_current' value="{{ page_current }}">
            <input type="hidden" name="action_type" id="action_type" value="">
            <div class="modal-content body">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">× </button>
                    <br/>
                </div>
                <div class="modal-body">
                    <div id="modal-body" style="overflow: hidden;">
                        <div class="body-img"
                             style="width: 180px; border: 1px solid #fff; border-radius: 4px; float: left;">
                            <label style="font-size: 12px">{{ dimension_limit }}</label>
                            <!--图片预览-->
                            <img id="uploadPreview" name='thumb' src="" alt="" width="100%" height="140px" style=";border-radius: 6px;display: block;margin-bottom: 5px;border: 1px solid #ccc;overflow: hidden;">
                            <!--图片文件-->
                            <input id="uploadImage" class="btn btn-primary" style="width: 100px;opacity: 0; position: absolute;" type="file" name="photo"  onchange="loadImageFile();"/>
                            <!--还原-->
                            <input id="discard" class="btn btn-primary" style="float: right" type="button"  onclick="recoveryImage();" value="还原"/>
                            <input class="btn btn-primary" type="button" value="选取图片"/>

                        </div>
                        <div class="body" style="float: right;width:calc(100% - 200px) ">
                            <!--显示-->
                            <div  class="form-group" style="overflow: hidden; margin-bottom: 5px">
                                <label style="width: 20%; line-height: 34px" class="col-sm-2 control-label" style="font-size: 16px;">标题:</label>
                                <input style="width: 80%;float: right" class="form-control" type="text" name="title" id="title">
                            </div>

                            <div  class="form-group" style="overflow: hidden; margin-bottom: 5px"
                                {% if category != 'bar' %}

                                hidden
                                {% end %}
                            >
                                <label style="width: 20%; line-height: 34px" class="col-sm-2 control-label" style="font-size: 16px;">链接:</label>
                                <input style="width: 80%;float: right" class="form-control" type="text" name="url" id="url">
                            </div>
                            <div  class="form-group" style="overflow: hidden;width: 50%; float:right;margin-bottom: 5px">
                                <label style="width: 40%; line-height: 34px" class="col-sm-2 control-label" style="font-size: 16px;">状态:</label>
                                <select style="width: 60%;float: right"  name="status" class="form-control" id="status">
                                    <option value="1">显示</option>
                                    <option value="0">隐藏</option>
                                </select>
                            </div>
                            <div  class="form-group" style="overflow: hidden;width: 50%;margin-bottom: 5px">
                                <label style="width: 40%; line-height: 34px" class="col-sm-2 control-label" style="font-size: 16px;">排序:</label>
                                <input style="width: 60%;float: right" class="form-control" type="number" name="sequence" id="sequence">
                            </div>
                             <div  class="form-group" style="overflow: hidden;margin-bottom: 5px">
                                <label style="width: 20%; line-height: 34px" class="col-sm-3 control-label" style="font-size: 16px;">描述:</label>
                                <textarea style="width: 80%;float: right" rows="5" class="form-control col-sm-9" type="text" name="summary" id="summary">
                                </textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" style="margin-left:  10px;">提交</button>
                    <!--<a id='commit_button' name="" class="btn btn-primary" style="margin-left:  10px;">提交</a>-->
                </div>
            </div>
        </form>
    </div>
</div>
{% end %}

{% block navi %}
    <h1 class="page-title">{{ title_content }}</h1>
    <ul class="breadcrumb">
        <li><a>{{ title_page }}</a></li>
        <li><a>{{ title_content }}</a></li>
    </ul>
{% end %}

{% block content %}
<!--顶部按钮-->
<div class="btn-toolbar list-toolbar">
    <a  id="add" class="btn btn-primary"><i class="fa fa-plus"></i> 添加</a>

    {% if len(url_preview) > 0 %}
        <a class="btn btn-primary" href="{{ url_preview }}" target="_blank"><i class="fa fa-eye"></i> 预览</a>
    {% end %}

    {% if len(url_preview2) > 0 %}
        <a class="btn btn-primary" href="{{ url_preview2 }}" target="_blank"><i class="fa fa-eye"></i> 首页预览</a>
    {% end %}

</div>

<div class="card-content">
    <div class="table-responsive" id="usertable">
        <table class="table table-striped table-bordered table-hover">
            <thead>
            <tr>
                <th></th>
                <th style="width: 80px">预览</th>
                <th style="width: 200px">标题</th>
                <th style="width: 400px">描述</th>
                <th>状态</th>
                <th>排序</th>
                <th style="width: 140px">操作</th>
            </tr>
            </thead>
            <tbody>
            {% for item in items %}
            <tr>
                <!--序号0-->
                <td>{{ items.index(item)+1 }}</td>
                <!--1-->
                <td hidden>{{ item['id'] }}</td>
                <!--2-->
                <td hidden>{{ item['path_file'] }}</td>
                <!--3-->
                <td hidden>{{ item['path_thumb'] }}</td>
                <!--4-->
                <td>
                    <div style="width: 50px; height: 50px;">
                        <img src="{{ item['path_thumb'] }}"
                             alt="" width="100%" height="100%"
                             onclick="showImage('{{ item['path_file'] }}')"
                        >
                    </div>
                </td>
                <!--5-->
                <td>{{ item['title'] }}</td>
                <!--6-->
                <td>{{ item['summary'] }}</td>
                <!--7-->
                {% if item['status'] == '1' %}
                <td>显示</td>
                {% else %}
                <td>隐藏</td>
                {% end %}
                <!--8-->
                <td>{{ item['sequence'] }}</td>
                <!--9 链接-->
                <td class="hidden">{{ item['url'] }}</td>
                <td>
                    <a href="#" class="edit"style="margin-right:8px" ><i class="fa fa-pencil" ></i>编辑 </a>
                    <a href="#" onclick="delete_item({{ item['id'] }})"><i class="fa fa-trash-o"></i>删除</a>
                </td>
            </tr>
            {% end %}
            </tbody>
        </table>
    </div>
</div>
    {% if page_total > 1 %}
    <!--分页栏-->
    <div class="tcdPageCode"></div>
    {% end %}
{% end %}

{% block js %}

<!--分页-->
<script>
    $(".tcdPageCode").createPage({
        pageCount: '{{ page_total }}',
        current: '{{ page_current }}',
        backFn: function (p) {
            window.location.href='/selector/{{ category }}?page_current=' + p;
        }
    });
</script>
<!--添加、编辑、删除-->
<script>
    // 编辑
    $('#usertable tbody a.edit').click(function () {
        imges = $(this).parents('tr').find('img').attr('src');
        $('#action_type').val('edit');
        $('#uploadImage').val('');
        $('#uploadPreview').attr('src', imges);
        $('#id').val($(this).parents('tr').find('td').eq(1).text());
        $('#title').val($(this).parents('tr').find('td').eq(5).text());
        $('#summary').val($(this).parents('tr').find('td').eq(6).text());
        $('#sequence').val($(this).parents('tr').find('td').eq(8).text());
        $('#url').val($(this).parents('tr').find('td').eq(9).text());
        if($(this).parents('tr').find('td').eq(7).text() == '显示'){
            $('#status').val(1);
        }else{
            $('#status').val(0);
        }
        // 显示
        $('#myModal').modal('show');
    });

    // 添加
    $('#add').click(function () {
        imges = '';
        $('#action_type').val('add');
        $('#id').val('');
        $('#uploadPreview').attr('src', '');
        $('#uploadImage').val('');
        $('#title').val('');
        $('#sequence').val(1);
        $('#status').val(1);
        $('#summary').val('');
        // 显示
        $('#myModal').modal('show');
    });

    // 删除
    function delete_item(id){
        if (true){
            var data = {
                'id_del': id,
                'page_current': '{{ page_current }}',
                '_xsrf': getCookie("_xsrf")
            };
            $.ajax({
                type:'post',
                url: '/selector-delete/{{ category }}',
                data: data,
                success: function (data) {
                    if(data != 'false'){
                        window.location.href='/selector/{{ category }}?page_current=' + data;
                    }else{
                        showAlert('信息', '删除失败')
                    }
                }
            });
        }
    }
</script>
{% end %}